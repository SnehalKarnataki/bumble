<html>

<head>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.2/full/pyodide.js"></script>
</head>

<body>
  <button id="connectButton" disabled>Connect</button>
  <br />
  <br />
  <div>Output:</div>
  <textarea id="output" style="width: 100%;" rows="30" disabled></textarea>

  <script type="module">
    import { loadBumble, connectWebSocketTransport } from "../bumble.js"
    let pyodide;
    let output;

    function logToOutput(s) {
      output.value += s + "\n";
      console.log(s);
    }

    async function run() {
      const params = (new URL(document.location)).searchParams;
      const hciWsUrl = params.get("hci") || "ws://localhost:9922/hci";

      try {
        // Create a WebSocket HCI transport
        let transport
        try {
          transport = await connectWebSocketTransport(pyodide, hciWsUrl);
        } catch (error) {
          logToOutput(error);
          return;
        }

        // Run the scanner example
        const script = await (await fetch("scanner.py")).text();
        await pyodide.runPythonAsync(script);
        const pythonMain = pyodide.globals.get("main");
        logToOutput("Starting scanner...");
        await pythonMain(transport.packet_source, transport.packet_sink);
        logToOutput("Scanner running");
      } catch (err) {
        logToOutput(err);
      }
    }

    async function main() {
      output = document.getElementById("output");

      // Load pyodide
      logToOutput("Loading Pyodide");
      pyodide = await loadPyodide();

      // Load Bumble
      logToOutput("Loading Bumble");
      const params = (new URL(document.location)).searchParams;
      const bumbleModule = params.get("module") || "bumble";
      await loadBumble(pyodide, bumbleModule);

      logToOutput("Ready!")

      // Enable the Connect button
      const connectButton = document.getElementById("connectButton");
      connectButton.disabled = false
      connectButton.addEventListener("click", run)
    }

    main();
  </script>
</body>

</html>